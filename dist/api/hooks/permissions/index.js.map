{"version":3,"sources":["hooks/permissions/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\n\nlet permissionPolicies = [\n    'passport',\n    'sessionAuth',\n    'ModelPolicy',\n    'OwnerPolicy',\n    'PermissionPolicy',\n    'RolePolicy'\n];\n\nconst path = require('path');\nconst _ = require('lodash');\nconst Marlinspike = require(\"marlinspike\");\n\nclass Permissions extends Marlinspike {\n\n    constructor(sails) {\n        super(sails, module);\n    }\n\n    configure() {\n        if (!_.isObject(sails.config.permissions)) {\n            sails.config.permissions = {};\n        }\n\n        /**\n         * Local cache of Model name -> id mappings to avoid excessive database lookups.\n         */\n        this.sails.config.blueprints.populate = false\n    }\n\n    initialize(next) {\n        let config = this.sails.config.permissions;\n\n        this.installModelOwnership();\n        this.sails.after(config.afterEvent, () => {\n            if (!this.validateDependencies()) {\n                this.sails.log.error('Cannot find sails-auth hook. Did you \"npm install sails-auth --save\"?');\n                this.sails.log.error('Please see README for installation instructions: https://github.com/tjwebb/sails-permissions');\n                return this.sails.lower()\n            }\n\n            if (!this.validatePolicyConfig()) {\n                this.sails.log.warn('One or more required policies are missing.');\n                this.sails.log.warn('Please see README for installation instructions: https://github.com/tjwebb/sails-permissions')\n            }\n\n        });\n\n        this.sails.after('hook:orm:loaded', () => {\n            sails.models.model.count()\n                .then(count => {\n                    if (count === _.keys(this.sails.models).length) {\n                        return next();\n                    }\n\n                    return this.initializeFixtures()\n                        .then(() => {\n                            next()\n                        })\n                })\n                .catch(error => {\n                    this.sails.log.error(error);\n                    next(error)\n                })\n        })\n    }\n\n    validatePolicyConfig() {\n        var policies = this.sails.config.policies;\n        return _.all([\n            _.isArray(policies['*']),\n            _.intersection(permissionPolicies, policies['*']).length === permissionPolicies.length,\n            policies.AuthController && _.includes(policies.AuthController['*'], 'passport')\n        ])\n    }\n\n    installModelOwnership() {\n        // sails.log.silly(`installModelOwnership() ${JSON.stringify(this.sails.models)} ${JSON.stringify(this.sails.config.models)}`);\n\n        var models = this.sails.models;\n        if (this.sails.config.models.autoCreatedBy === false) {\n            sails.log.silly(`installModelOwnership() (ABORT) (this.sails.config.models.autoCreatedBy === false)`);\n            return;\n        }\n\n        _.each(models, model => {\n            if (model.autoCreatedBy === false) {\n                sails.log.silly(`installModelOwnership() (ABORT) (model.autoCreatedBy === false)`);\n                return;\n            }\n\n            _.defaults(model.attributes, {\n                createdBy: {\n                    model: 'User',\n                    index: true\n                },\n                owner: {\n                    model: 'User',\n                    index: true\n                }\n            });\n\n            // sails.log.silly(`installModelOwnership() (attach) ${JSON.stringify(model.attributes)}`);\n        })\n    }\n\n    /**\n     * Install the application. Sets up default Roles, Users, Models, and\n     * Permissions, and creates an admin user.\n     */\n    initializeFixtures() {\n        let fixturesPath = path.resolve(__dirname, '../../../config/fixtures/');\n        return require(path.resolve(fixturesPath, 'model')).createModels()\n            .then(models => {\n                this.models = models;\n                this.sails.hooks.permissions._modelCache = _.keyBy(models, 'identity');\n\n                return require(path.resolve(fixturesPath, 'role')).create()\n            })\n            .then(roles => {\n                this.roles = roles;\n\n                if (!this.sails.config.permissions.autoCreateAdmin) {\n                    return;\n                }\n\n                return Promise.resolve()\n                    .then(() => {\n                        var userModel = _.find(this.models, {name: 'User'});\n                        return require(path.resolve(fixturesPath, 'user')).create(this.roles, userModel)\n                    })\n                    .then(() => {\n                        return sails.models.user.findOne({email: this.sails.config.permissions.adminEmail})\n                    })\n                    .then(user => {\n                        this.sails.log('sails-permissions: created admin user:', user);\n                        user.createdBy = user.id;\n                        user.owner = user.id;\n                        return user.save()\n                    })\n                    .then(admin => {\n                        return require(path.resolve(fixturesPath, 'permission')).create(this.roles, this.models, admin, this.sails.config.permissions);\n                    });\n            })\n            .catch(error => {\n                this.sails.log.error(error)\n            });\n    }\n\n    validateDependencies() {\n        return !!this.sails.hooks.auth;\n    }\n}\n\nexport default Marlinspike.createSailsHook(Permissions)\n"]}
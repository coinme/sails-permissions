{"version":3,"sources":["policies/CriteriaPolicy.js"],"names":[],"mappings":"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","file":"CriteriaPolicy.js","sourcesContent":["\"use strict\";\n\n/**\n * CriteriaPolicy\n * @depends PermissionPolicy\n *\n * Verify that the User fulfills permission 'where' conditions and attribute blacklist restrictions\n */\nconst wlFilter = require('waterline-criteria');\nconst _ = require('lodash');\n\nmodule.exports = function(req, res, next) {\n  var permissions = req.permissions;\n\n  if (_.isEmpty(permissions)) {\n    return next();\n  }\n\n  var action = PermissionService.getMethod(req.method);\n\n  var body = req.body || req.query;\n\n  // if we are creating, we don't need to query the db, just check the where clause vs the passed in data\n  if (action === 'create') {\n    if (!PermissionService.hasPassingCriteria(body, permissions, body)) {\n      return res.send(403, {\n        error: 'Can\\'t create this object, because of failing where clause'\n      });\n    }\n    return next();\n  }\n\n\n  // set up response filters if we are not mutating an existing object\n  if (!_.includes(['update', 'delete'], action)) {\n\n    // get all of the where clauses and blacklists into one flat array\n    // if a permission has no criteria then it is always true\n    var criteria = _.compact(_.flatten(\n      _.map(\n        _.pluck(permissions, 'criteria'),\n        function(c) {\n          if (c.length == 0) {\n            return [{where: {}}];\n          }\n          return c;\n        }\n      )\n    ));\n\n    if (criteria.length) {\n      bindResponsePolicy(req, res, criteria);\n    }\n    return next();\n  }\n\n  PermissionService.findTargetObjects(req)\n    .then(function(objects) {\n\n      // attributes are not important for a delete request\n      if (action === 'delete') {\n        body = undefined;\n      }\n\n      if (!PermissionService.hasPassingCriteria(objects, permissions, body, req.user.id)) {\n        return res.send(403, {\n          error: 'Can\\'t ' + action + ', because of failing where clause or attribute permissions'\n        });\n      }\n\n      next();\n    })\n    .catch(next);\n};\n\nfunction bindResponsePolicy(req, res, criteria) {\n  res._ok = res.ok;\n\n  res.ok = _.bind(responsePolicy, {\n    req: req,\n    res: res\n  }, criteria);\n}\n\nfunction responsePolicy(criteria, _data, options) {\n  var req = this.req;\n  var res = this.res;\n  var user = req.owner;\n  var method = PermissionService.getMethod(req);\n  var isResponseArray = _.isArray(_data);\n\n  var data = isResponseArray ? _data : [_data];\n\n  // remove undefined, since that is invalid input for waterline-criteria\n  data = data.filter(item => { return item !== undefined })\n\n  var permitted = data.reduce(function(memo, item) {\n    criteria.some(function(crit) {\n      var filtered = wlFilter([item], {\n        where: {\n          or: [crit.where || {}]\n        }\n      }).results;\n\n      if (filtered.length) {\n\n        if (crit.blacklist && crit.blacklist.length) {\n          crit.blacklist.forEach(function (term) {\n            delete item[term];\n          });\n        }\n        memo.push(item);\n        return true;\n      }\n    });\n    return memo;\n  }, []);\n\n  if (isResponseArray) {\n    return res._ok(permitted, options);\n  } else if (permitted.length === 0) {\n    sails.log.silly('permitted.length === 0');\n    return res.send(404);\n  } else {\n    res._ok(permitted[0], options);\n  }\n}\n"]}